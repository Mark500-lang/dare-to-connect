workflows:
  ios-release:
    name: Dare to Connect iOS Release Build
    integrations:
      app_store_connect: codemagic-key
    environment:
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        NODE_VERSION: "22.x"
        COCOAPODS_VERSION: "1.15.2"
        DEVELOPMENT_TEAM: "H9A4H444G4"  # Replace with your actual team ID
        BUNDLE_ID: "daretoconnect.app.mobile"
        CI: "false"
        DISABLE_ESLINT_PLUGIN: "true"
      groups:
        - DareToConnect
      node: 22
      xcode: latest
    cache:
      cache_paths:
        - ~/.npm
        - node_modules
        - ios/Pods
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
        - pattern: master
          include: true
        - pattern: develop
          include: true

    scripts:
      # PHASE 1: CLEAN AND SETUP
      - name: Clean Workspace
        script: |
          echo "=== Cleaning Workspace ==="
          rm -rf node_modules ios/Pods ios/App/Pods
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          rm -rf ios/Pods ios/Podfile.lock
          npm cache clean --force

      # PHASE 2: DEPENDENCY INSTALLATION
      - name: Install Dependencies
        script: |
          set -ex
          echo "=== Installing Node Modules ==="
          
          # Clean install with aligned versions
          rm -rf node_modules package-lock.json
          npm install @revenuecat/purchases-capacitor@12.1.1 @revenuecat/purchases-capacitor-ui@12.1.1 --save-exact
          
          # Use npm install instead of npm ci since we just regenerated package-lock.json
          npm install
          
          echo "=== Installing missing Babel plugin ==="
          npm install --save-dev @babel/plugin-proposal-private-property-in-object
          
          echo "=== Updating browserslist ==="
          npx update-browserslist-db@latest

          echo "=== Verifying RevenueCat installation ==="
          if [ -d "node_modules/@revenuecat/purchases-capacitor" ]; then
            echo "âœ… @revenuecat/purchases-capacitor installed successfully"
            echo "Version: $(node -p "require('@revenuecat/purchases-capacitor/package.json').version")"
          else
            echo "âŒ @revenuecat/purchases-capacitor not found in node_modules"
            exit 1
          fi
          
          if [ -d "node_modules/@revenuecat/purchases-capacitor-ui" ]; then
            echo "âœ… @revenuecat/purchases-capacitor-ui installed successfully"
            echo "Version: $(node -p "require('@revenuecat/purchases-capacitor-ui/package.json').version")"
          else
            echo "âŒ @revenuecat/purchases-capacitor-ui not found in node_modules"
            exit 1
          fi

      # PHASE 3: BUILD REACT APP
      - name: Build React App
        script: |
          set -ex
          echo "=== Building React App ==="
          export DISABLE_ESLINT_PLUGIN=true
          export ESLINT_NO_DEV_ERRORS=false
          
          npm run build
          
          if [ ! -d "build" ]; then
            echo "âŒ React build failed - build directory not found"
            exit 1
          fi
          
          echo "âœ… React build completed successfully"

      # PHASE 4: CAPACITOR SYNC WITH COMPLETE MANUAL POD CONTROL
      - name: Sync Capacitor and Configure IAP
        script: |
          set -ex
          echo "=== Syncing Capacitor for iOS ==="
          
          # Only add iOS platform if it doesn't exist
          if [ ! -d "ios" ]; then
            echo "=== Adding iOS platform ==="
            npx cap add ios
          fi
          
          # Copy web assets only
          echo "=== Copying web assets ==="
          npx cap copy ios
          
          echo "=== Creating clean Podfile with iOS 15.0 target ==="
          cd ios/App
          
          # COMPLETE NUCLEAR CLEAN
          echo "=== Performing nuclear clean ==="
          rm -rf Pods Podfile.lock
          rm -f Podfile
          
          # Clear all CocoaPods caches
          rm -rf ~/.cocoapods/repos/trunk/
          pod cache clean --all
          pod repo remove trunk || true
          pod setup
          
          # Get the exact podspec names
          RC_PODSPEC=$(basename $(ls ../../node_modules/@revenuecat/purchases-capacitor/*.podspec | head -1) .podspec)
          UI_PODSPEC=$(basename $(ls ../../node_modules/@revenuecat/purchases-capacitor-ui/*.podspec | head -1) .podspec)
          
          echo "RevenueCat pod: $RC_PODSPEC"
          echo "RevenueCat UI pod: $UI_PODSPEC"
          
          # Create minimal Podfile first
          cat > Podfile << EOF
          platform :ios, '15.0'
          use_frameworks!
          
          target 'App' do
            # Only RevenueCat pods first
            pod '$RC_PODSPEC', :path => '../../node_modules/@revenuecat/purchases-capacitor'
            pod '$UI_PODSPEC', :path => '../../node_modules/@revenuecat/purchases-capacitor-ui'
          end
          EOF
          
          echo "=== Installing RevenueCat pods first ==="
          pod install --repo-update
          
          # Now add the rest of the pods
          cat > Podfile << EOF
          platform :ios, '15.0'
          use_frameworks!
          
          install! 'cocoapods', :deterministic_uuids => false, :integrate_targets => true
          
          target 'App' do
            # RevenueCat pods
            pod '$RC_PODSPEC', :path => '../../node_modules/@revenuecat/purchases-capacitor'
            pod '$UI_PODSPEC', :path => '../../node_modules/@revenuecat/purchases-capacitor-ui'
            
            # Capacitor core
            pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
            pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
          EOF
          
          # Add Capacitor plugins
          echo "" >> Podfile
          echo "  # Capacitor plugins" >> Podfile
          
          # Add each Capacitor plugin
          if [ -d "../../node_modules/@capacitor" ]; then
            for plugin in ../../node_modules/@capacitor/*; do
              if [ -d "$plugin" ]; then
                plugin_name=$(basename "$plugin")
                # Skip non-iOS plugins
                if [ "$plugin_name" != "android" ] && [ "$plugin_name" != "cli" ] && [ "$plugin_name" != "core" ] && [ "$plugin_name" != "ios" ]; then
                  # Look for podspec files
                  for podspec in "$plugin"/*.podspec; do
                    if [ -f "$podspec" ]; then
                      pod_name=$(basename "$podspec" .podspec)
                      echo "  pod '$pod_name', :path => '../../node_modules/@capacitor/$plugin_name'" >> Podfile
                    fi
                  done
                fi
              fi
            done
          fi
          
          # Close the target and add post_install hook
          cat >> Podfile << 'EOF'
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
                config.build_settings['SWIFT_VERSION'] = '5.0'
                config.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'YES'
              end
            end
          end
          EOF
          
          echo "=== Installing all pods ==="
          pod install
          
          # Verify RevenueCat UI was installed
          if grep -q "$UI_PODSPEC" Podfile.lock; then
            echo "âœ… RevenueCat UI ($UI_PODSPEC) successfully installed"
          else
            echo "âŒ RevenueCat UI not found in Podfile.lock"
            exit 1
          fi
          
          cd ../..
          
          echo "âœ… iOS dependencies configured successfully"

      # PHASE 5: IOS PROJECT CONFIGURATION (SIMPLIFIED)
      - name: Configure iOS Project
        script: |
          set -ex
          echo "=== Setting up iOS Platform ==="
          cd ios/App
          
          # Create proper Podfile with Swift support
          cat > Podfile << 'EOF'
          platform :ios, '15.0'
          use_frameworks!
          
          # Disable bitcode for all targets
          installer = Pod::Installer
          
          target 'App' do
            # Let Capacitor handle its own pods via the symlink
            # This ensures RevenueCat is properly linked
            
            # Explicitly add RevenueCat to ensure Swift support
            pod 'Purchases', '~> 5.0'
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
                config.build_settings['SWIFT_VERSION'] = '5.0'
                config.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'YES'
                
                # Critical for RevenueCat: Ensure Swift is properly linked
                config.build_settings['LD_RUNPATH_SEARCH_PATHS'] = [
                  '$(inherited)',
                  '@executable_path/Frameworks'
                ]
              end
            end
          end
          EOF
          
          # Append Capacitor pods
          echo "" >> Podfile
          echo "# Capacitor pods (auto-generated)" >> Podfile
          
          # Find all Capacitor pods
          find ../../node_modules/@capacitor -name "*.podspec" -maxdepth 2 | while read spec; do
            pod_name=$(basename "$spec" .podspec)
            echo "pod '$pod_name', :path => '../../node_modules/@capacitor/ios''" >> Podfile
          done
          
          # Find RevenueCat and other plugins
          find ../../node_modules/@revenuecat -name "*.podspec" -maxdepth 2 | while read spec; do
            pod_name=$(basename "$spec" .podspec)
            echo "pod '$pod_name', :path => '../../node_modules/@revenuecat/purchases-capacitor/ios''" >> Podfile
          done
          
          # Clean install pods
          pod deintegrate || true
          pod install --repo-update
          
          echo "âœ… iOS project configured with Swift 5.0 support"

      # PHASE 7: CREATE XCODE SCHEME
      - name: Create Xcode Scheme
        script: |
          set -ex
          echo "=== Creating Xcode scheme ==="
          cd ios/App
          
          # Create scheme directory
          mkdir -p App.xcodeproj/xcshareddata/xcschemes
          
          # Create scheme file
          cat > App.xcodeproj/xcshareddata/xcschemes/App.xcscheme << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <Scheme LastUpgradeVersion="1500" version="1.7">
            <BuildAction parallelizeBuildables="YES" buildImplicitDependencies="YES">
              <BuildActionEntries>
                <BuildActionEntry buildForTesting="YES" buildForRunning="YES" buildForProfiling="YES" buildForArchiving="YES" buildForAnalyzing="YES">
                  <BuildableReference BuildableIdentifier="primary" BlueprintIdentifier="1DF1B9C3257A6D4E00F1B1A6" BuildableName="App.app" BlueprintName="App" ReferencedContainer="container:App.xcodeproj"/>
                </BuildActionEntry>
              </BuildActionEntries>
            </BuildAction>
            <TestAction buildConfiguration="Debug" selectedDebuggerIdentifier="Xcode.DebuggerFoundation.Debugger.LLDB" selectedLauncherIdentifier="Xcode.DebuggerFoundation.Launcher.LLDB" shouldUseLaunchSchemeArgsEnv="YES" codeCoverageEnabled="YES">
              <Testables/>
            </TestAction>
            <LaunchAction buildConfiguration="Debug" selectedDebuggerIdentifier="Xcode.DebuggerFoundation.Debugger.LLDB" selectedLauncherIdentifier="Xcode.DebuggerFoundation.Launcher.LLDB" launchStyle="0" useCustomWorkingDirectory="NO" ignoresPersistentStateOnLaunch="NO" debugDocumentVersioning="YES" debugServiceExtension="internal" allowLocationSimulation="YES">
              <BuildableProductRunnable runnableDebuggingMode="0">
                <BuildableReference BuildableIdentifier="primary" BlueprintIdentifier="1DF1B9C3257A6D4E00F1B1A6" BuildableName="App.app" BlueprintName="App" ReferencedContainer="container:App.xcodeproj"/>
              </BuildableProductRunnable>
            </LaunchAction>
            <ProfileAction buildConfiguration="Release" shouldUseLaunchSchemeArgsEnv="YES" savedToolIdentifier="" useCustomWorkingDirectory="NO" debugDocumentVersioning="YES">
              <BuildableProductRunnable runnableDebuggingMode="0">
                <BuildableReference BuildableIdentifier="primary" BlueprintIdentifier="1DF1B9C3257A6D4E00F1B1A6" BuildableName="App.app" BlueprintName="App" ReferencedContainer="container:App.xcodeproj"/>
              </BuildableProductRunnable>
            </ProfileAction>
            <AnalyzeAction buildConfiguration="Debug"/>
            <ArchiveAction buildConfiguration="Release" revealArchiveInOrganizer="YES"/>
          </Scheme>
          EOF
          
          echo "âœ… Xcode scheme created"

      # PHASE 8: CODE SIGNING SETUP (IMPROVED)
      - name: Configure Signing
        script: |
          set -ex
          echo "=== Setting Up Signing ==="
          cd ios/App
          
          # Import certificates
          echo "$CERTIFICATE" | base64 --decode > signing.p12
          echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
          
          # Extract provisioning profile info
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision 2>/dev/null))
          TEAM_IDENTIFIER=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' /dev/stdin <<< $(security cms -D -i profile.mobileprovision 2>/dev/null))
          
          echo "Profile UUID: $PROFILE_UUID"
          echo "Team ID: $TEAM_IDENTIFIER"
          
          # Setup keychain
          security create-keychain -p "" build.keychain
          security import signing.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -k "" build.keychain
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
          
          # Instead of modifying Pod xcconfigs (which often breaks), use a project override
          cd App.xcodeproj
          
          # Create a signing config file
          cat > signing.xcconfig << EOF
          CODE_SIGN_STYLE = Manual
          DEVELOPMENT_TEAM = $TEAM_IDENTIFIER
          PROVISIONING_PROFILE_SPECIFIER = $PROFILE_UUID
          CODE_SIGN_IDENTITY = Apple Distribution
          CODE_SIGNING_ALLOWED = YES
          CODE_SIGNING_REQUIRED = YES
          EOF
          
          # Update project to use this config
          cd ..
          
          # Use xcodebuild to set the provisioning profile (more reliable than sed)
          xcodebuild -workspace App.xcworkspace -scheme App -configuration Release PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" DEVELOPMENT_TEAM="$TEAM_IDENTIFIER" CODE_SIGN_STYLE=Manual
          
          echo "PROFILE_UUID=$PROFILE_UUID" >> $CM_ENV
          echo "âœ… Signing configuration complete"

      # PHASE 9: BUILD CONFIGURATION WITH VERSION INCREMENT
      - name: Configure Build Settings
        script: |
          set -ex
          cd ios/App/App
          
          echo "=== Updating Version Numbers ==="
          PLIST_PATH="Info.plist"
          
          # Get current version and build number
          CURRENT_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH" 2>/dev/null || echo "2.3")
          CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH" 2>/dev/null || echo "1")
          
          echo "Current version: $CURRENT_VERSION"
          echo "Current build: $CURRENT_BUILD"
          
          # Parse version components safely
          MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)
          
          # Handle cases where PATCH might be empty
          if [ -z "$PATCH" ] || [ "$PATCH" = "$CURRENT_VERSION" ]; then
            PATCH="0"
          fi
          
          # Increment patch version (2.2.0 â†’ 2.3.0)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          # Generate timestamp-based build number for uniqueness
          NEW_BUILD=$(date +%s)
          
          echo "New version: $NEW_VERSION"
          echo "New build: $NEW_BUILD"
          
          # Update both version and build number
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $NEW_VERSION" "$PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" "$PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" "$PLIST_PATH"
          
          # Add Swift support requirements
          /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string APPL" "$PLIST_PATH" 2>/dev/null || true
          
          echo "=== Verifying Plist Changes ==="
          FINAL_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH")
          FINAL_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH")
          FINAL_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST_PATH")
          
          echo "Final CFBundleShortVersionString: $FINAL_VERSION"
          echo "Final CFBundleVersion: $FINAL_BUILD"
          echo "Final CFBundleIdentifier: $FINAL_BUNDLE_ID"
          
          # Critical validation - ensure CFBundleShortVersionString is set
          if [ -z "$FINAL_VERSION" ] || [[ "$FINAL_VERSION" == *"$"* ]]; then
            echo "âŒ CRITICAL: CFBundleShortVersionString is not properly set!"
            echo "Setting fallback version: 2.3.0"
            /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 2.3.0" "$PLIST_PATH"
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" "$PLIST_PATH"
          fi
          
          # Final verification
          echo "=== Final Verification ==="
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH"
          
          echo "âœ… Build settings configured definitively"

      # PHASE 10: ADD PRIVACY DESCRIPTIONS
      - name: Add Privacy Descriptions
        script: |
          set -ex
          cd ios/App/App
          
          echo "=== Adding Required Privacy Descriptions ==="
          PLIST_PATH="Info.plist"
          
          # Add microphone usage description for voice recording
          /usr/libexec/PlistBuddy -c "Add :NSMicrophoneUsageDescription string 'Used for voice recording in games and activities'" "$PLIST_PATH" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :NSMicrophoneUsageDescription 'Used for voice recording in games and activities'" "$PLIST_PATH"
          
          echo "âœ… Privacy descriptions added"

      # PHASE 11: APP ENCRYPTION COMPLIANCE
      - name: Add App Encryption Compliance
        script: |
          set -ex
          cd ios/App/App
          
          echo "=== Adding App Encryption Compliance Documentation ==="
          PLIST_PATH="Info.plist"
          
          # Add the key that indicates we only use Apple's standard encryption
          /usr/libexec/PlistBuddy -c "Add :ITSAppUsesNonExemptEncryption bool false" "$PLIST_PATH" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :ITSAppUsesNonExemptEncryption false" "$PLIST_PATH"
          
          echo "âœ… Added ITSAppUsesNonExemptEncryption = false to Info.plist"

      # PHASE 12: BUILD ARCHIVE
      - name: Build Archive
        script: |
          set -ex
          cd ios/App
          
          echo "=== Building Archive ==="
          rm -rf build/*
          
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            clean archive
          
          if [ ! -d "build/App.xcarchive" ]; then
            echo "âŒ Archive failed"
            exit 1
          fi
          
          echo "âœ… Archive created successfully"

      # PHASE 13: EXPORT IPA
      - name: Export IPA
        script: |
          set -ex
          cd ios/App
          
          echo "=== Exporting IPA ==="
          
          # Create export options plist
          cat > build/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$DEVELOPMENT_TEAM</string>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist build/exportOptions.plist \
            -allowProvisioningUpdates
          
          if [ ! -f "build/ipa/App.ipa" ]; then
            echo "âŒ IPA export failed"
            exit 1
          fi
          
          echo "âœ… IPA exported successfully"

      # PHASE 14: VALIDATION AND ARTIFACT PREPARATION
      - name: Validate Build and Prepare Artifacts
        script: |
          set -ex
          echo "=== Validating Build Artifacts ==="
          
          if [ ! -f "ios/App/build/ipa/App.ipa" ]; then
            echo "âŒ IPA file not found"
            exit 1
          fi
          
          # Check IPA contents
          unzip -l "ios/App/build/ipa/App.ipa" | grep "Payload/App.app" || {
            echo "âŒ Invalid IPA structure"
            exit 1
          }
          
          # Verify signing in the final IPA
          TEMP_DIR=$(mktemp -d)
          unzip -q ios/App/build/ipa/App.ipa -d "$TEMP_DIR"
          codesign -dv --verbose=4 "$TEMP_DIR/Payload/App.app" 2>&1 | grep -E 'Authority=Apple Distribution|TeamIdentifier=' || {
            echo "âŒ Final IPA signing verification failed";
            exit 1;
          }
          rm -rf "$TEMP_DIR"
          
          # Create final Info.plist verification artifact
          cd ios/App/App
          cp Info.plist Final_Info_Plist_Verification.plist
          echo "=== FINAL INFO.PLIST CONTENTS ===" > Info_Plist_Verification.txt
          /usr/libexec/PlistBuddy -c "Print" Info.plist >> Info_Plist_Verification.txt
          
          echo "âœ… Build validation successful"
          echo "ðŸ“± IPA file size: $(du -h ios/App/build/ipa/App.ipa | cut -f1)"

    artifacts:
      - ios/App/build/ipa/App.ipa
      - ios/App/App/Final_Info_Plist_Verification.plist
      - ios/App/App/Info_Plist_Verification.txt

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true